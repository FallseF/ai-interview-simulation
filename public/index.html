<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI面接シミュレーション</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
      color: #1a1a1a;
    }

    /* Header */
    .header {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1a1a1a;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      background: #fef2f2;
      color: #dc2626;
    }

    .status-badge.connected {
      background: #f0fdf4;
      color: #16a34a;
    }

    .status-badge.connecting {
      background: #fefce8;
      color: #ca8a04;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #dc2626;
    }

    .status-badge.connected .status-dot {
      background: #16a34a;
    }

    .status-badge.connecting .status-dot {
      background: #ca8a04;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Main Layout */
    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 65px);
    }

    /* Participants Bar */
    .participants-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .participant-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 24px;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .participant-chip.speaking {
      border-color: transparent;
      box-shadow: 0 0 0 2px #3b82f6;
    }

    .participant-chip.interviewer.speaking {
      box-shadow: 0 0 0 2px #6366f1;
    }

    .participant-chip.maria.speaking {
      box-shadow: 0 0 0 2px #ec4899;
    }

    .participant-chip.user.speaking {
      box-shadow: 0 0 0 2px #10b981;
    }

    .chip-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
    }

    .chip-avatar.interviewer {
      background: #eef2ff;
      color: #6366f1;
    }

    .chip-avatar.user {
      background: #ecfdf5;
      color: #10b981;
    }

    .chip-avatar.maria {
      background: #fdf2f8;
      color: #ec4899;
    }

    .chip-avatar .icon {
      width: 100%;
      height: 100%;
    }

    .chip-info {
      display: flex;
      flex-direction: column;
    }

    .chip-name {
      font-weight: 500;
      color: #1a1a1a;
      line-height: 1.2;
    }

    .chip-role {
      font-size: 0.7rem;
      color: #6b7280;
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Message Bubbles */
    .message {
      display: flex;
      gap: 12px;
      max-width: 85%;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.interviewer {
      align-self: flex-start;
    }

    .message.maria {
      align-self: flex-start;
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message.system {
      align-self: center;
      max-width: 100%;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 7px;
      flex-shrink: 0;
    }

    .message-avatar.interviewer {
      background: #eef2ff;
      color: #6366f1;
    }

    .message-avatar.maria {
      background: #fdf2f8;
      color: #ec4899;
    }

    .message-avatar.user {
      background: #ecfdf5;
      color: #10b981;
    }

    .message-avatar .icon {
      width: 100%;
      height: 100%;
    }

    .message-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .message-sender {
      font-size: 0.75rem;
      font-weight: 500;
      color: #6b7280;
    }

    .message.user .message-sender {
      text-align: right;
    }

    .message-bubble {
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .message.interviewer .message-bubble {
      background: #eef2ff;
      color: #3730a3;
      border-bottom-left-radius: 4px;
    }

    .message.maria .message-bubble {
      background: #fdf2f8;
      color: #9d174d;
      border-bottom-left-radius: 4px;
    }

    .message.user .message-bubble {
      background: #ecfdf5;
      color: #065f46;
      border-bottom-right-radius: 4px;
    }

    .message.system .message-bubble {
      background: #f3f4f6;
      color: #6b7280;
      font-size: 0.8rem;
      padding: 8px 16px;
      border-radius: 8px;
    }

    /* Phase Indicator */
    .phase-indicator {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      background: #fafafa;
    }

    .phase-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .phase-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #d1d5db;
    }

    .phase-dot.active {
      background: #3b82f6;
      animation: pulse 1.5s infinite;
    }

    .phase-dot.interviewer { background: #6366f1; }
    .phase-dot.maria { background: #ec4899; }
    .phase-dot.user { background: #10b981; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .phase-text {
      font-size: 0.85rem;
      color: #6b7280;
      font-weight: 500;
    }

    /* Action Buttons */
    .action-buttons {
      display: none;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      background: #fff;
      justify-content: center;
    }

    .action-buttons.visible {
      display: flex;
    }

    .action-btn {
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      border: none;
    }

    .action-btn.primary {
      background: #3b82f6;
      color: #fff;
    }

    .action-btn.primary:hover {
      background: #2563eb;
    }

    .action-btn.secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }

    .action-btn.secondary:hover {
      background: #e5e7eb;
    }

    .action-btn.success {
      background: #10b981;
      color: #fff;
    }

    .action-btn.success:hover {
      background: #059669;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* SVG Icons */
    .icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .icon-sm {
      width: 16px;
      height: 16px;
    }

    /* User Speaking Controls */
    .user-speaking-panel {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 24px 20px;
      border-top: 1px solid #e5e7eb;
      background: linear-gradient(to bottom, #ecfdf5, #fff);
    }

    .user-speaking-panel.visible {
      display: flex;
    }

    .mic-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #10b981;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .mic-icon-wrapper {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #10b981;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: micPulse 1.5s infinite;
    }

    .mic-icon-wrapper .icon {
      width: 24px;
      height: 24px;
      color: #fff;
    }

    @keyframes micPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
      50% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
    }

    /* End Screen */
    .end-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 32px 20px;
      border-top: 1px solid #e5e7eb;
      background: #fff;
    }

    .end-screen.visible {
      display: flex;
    }

    .end-icon-wrapper {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #f0fdf4;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .end-icon-wrapper .icon {
      width: 28px;
      height: 28px;
      color: #16a34a;
    }

    .end-screen.aborted .end-icon-wrapper {
      background: #fef2f2;
    }

    .end-screen.aborted .end-icon-wrapper .icon {
      color: #dc2626;
    }

    .end-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1a1a1a;
    }

    .end-message {
      font-size: 0.9rem;
      color: #6b7280;
      text-align: center;
    }

    /* Control Bar */
    .control-bar {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      background: #fff;
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .control-btn {
      padding: 12px 28px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #374151;
    }

    .control-btn:hover {
      background: #f3f4f6;
    }

    .control-btn.start {
      background: #3b82f6;
      color: #fff;
      border-color: #3b82f6;
    }

    .control-btn.start:hover {
      background: #2563eb;
    }

    .control-btn.start:disabled {
      background: #93c5fd;
      border-color: #93c5fd;
      cursor: not-allowed;
    }

    .control-btn.stop {
      border-color: #dc2626;
      color: #dc2626;
    }

    .control-btn.stop:hover {
      background: #fef2f2;
    }

    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Instructions Card */
    .instructions-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .instructions-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .instructions-icon-wrapper {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: #eef2ff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .instructions-icon-wrapper .icon {
      width: 16px;
      height: 16px;
      color: #6366f1;
    }

    .instructions-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #1a1a1a;
    }

    .instructions-text {
      font-size: 0.85rem;
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .instructions-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .instruction-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 0.85rem;
      color: #4b5563;
    }

    .instruction-number {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: #6b7280;
      flex-shrink: 0;
    }

    /* Audio Visualizer */
    .visualizer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
      height: 32px;
      padding: 0 16px;
    }

    .visualizer-bar {
      width: 3px;
      background: #d1d5db;
      border-radius: 2px;
      transition: height 0.1s, background 0.2s;
    }

    .visualizer-bar.active {
      background: #3b82f6;
    }

    .visualizer-bar.interviewer { background: #6366f1; }
    .visualizer-bar.maria { background: #ec4899; }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 20px;
      color: #9ca3af;
    }

    .empty-icon-wrapper {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }

    .empty-icon-wrapper .icon {
      width: 32px;
      height: 32px;
      color: #9ca3af;
    }

    .empty-text {
      font-size: 0.9rem;
      text-align: center;
      line-height: 1.6;
    }

    /* Scrollbar */
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .main-container {
        padding: 16px;
      }

      .participants-bar {
        gap: 8px;
      }

      .participant-chip {
        padding: 6px 12px;
        font-size: 0.8rem;
      }

      .chip-avatar {
        width: 24px;
        height: 24px;
        font-size: 0.65rem;
      }

      .message {
        max-width: 90%;
      }

      .action-buttons {
        flex-direction: column;
      }

      .action-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- SVG Icons (hidden) -->
  <svg style="display: none;">
    <!-- UI Icons (Lucide style) -->
    <symbol id="icon-mic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
      <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
      <line x1="12" x2="12" y1="19" y2="22"></line>
    </symbol>
    <symbol id="icon-play" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="6 3 20 12 6 21 6 3"></polygon>
    </symbol>
    <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="20 6 9 17 4 12"></polyline>
    </symbol>
    <symbol id="icon-check-circle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
      <polyline points="22 4 12 14.01 9 11.01"></polyline>
    </symbol>
    <symbol id="icon-alert-triangle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
      <line x1="12" x2="12" y1="9" y2="13"></line>
      <line x1="12" x2="12.01" y1="17" y2="17"></line>
    </symbol>
    <symbol id="icon-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
      <path d="M21 3v5h-5"></path>
      <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
      <path d="M8 16H3v5"></path>
    </symbol>
    <symbol id="icon-message" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </symbol>
    <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" x2="12" y1="16" y2="12"></line>
      <line x1="12" x2="12.01" y1="8" y2="8"></line>
    </symbol>
    <!-- Person Icons (from UXWing - free, no attribution required) -->
    <symbol id="icon-interviewer" viewBox="0 0 122.88 121.84">
      <path fill="currentColor" fill-rule="evenodd" d="M46.39,70.56c-3.15-2.8-5.64-4.82-6.17-10.64h-.34a4.42,4.42,0,0,1-2.23-.58,6.13,6.13,0,0,1-2.46-3c-1.14-2.61-2-9.46.82-11.42l-.53-.36-.06-.76c-.11-1.38-.14-3-.17-4.8-.1-6.44-.23-14.26-5.42-15.82l-2.22-.67,1.46-1.82a84.53,84.53,0,0,1,13-13.17C47,3.6,52.12,1,57.08.23A18,18,0,0,1,71.7,4.32a27.47,27.47,0,0,1,3.92,3.93,16.63,16.63,0,0,1,11.7,6.84,23.76,23.76,0,0,1,3.81,7.69,26.15,26.15,0,0,1,1,8.72,20.93,20.93,0,0,1-6.07,14.13,4.3,4.3,0,0,1,1.89.48c2.16,1.16,2.23,3.67,1.66,5.78-.56,1.75-1.27,3.8-1.94,5.51-.82,2.32-2,2.75-4.32,2.5-.12,5.72-2.77,7.3-6.33,10.66.15,8.62-30.84,7.61-30.65,0Zm-1.61,7.11L54,104.31l4.63-15.63L56.37,86.2c-1.71-2.5-1.12-5.33,2-5.84a21.61,21.61,0,0,1,3.43-.07,18.84,18.84,0,0,1,3.77.14c2.94.65,3.25,3.5,1.78,5.77l-2.27,2.48,4.63,15.63L78.1,77.67c6,5.41,27.21,6.5,33.84,10.2,9.18,5.14,8.93,24.78,10.94,34H0c2-9.11,1.79-28.91,10.94-34,8.15-4.54,27.17-4.19,33.84-10.2Z"/>
    </symbol>
    <symbol id="icon-user" viewBox="0 0 122.88 115.96">
      <path fill="currentColor" fill-rule="evenodd" d="M45.41,69.61c.35-2.91-8.3-14.06-9.88-19.4-3.39-5.38-4.59-13.94-.9-19.63,1.47-2.26.84-4.22.84-7.35,0-31,54.27-31,54.27,0,0,3.92-.89,4.84,1.22,7.93,3.55,5.15,1.73,14.29-1.27,19.07-1.93,5.61-11,16.22-10.37,19.4.57,15.9-34,15.37-33.91,0Zm19.78,27.5H67.1A3.13,3.13,0,0,0,70.22,94V88.93a3.12,3.12,0,0,0-3.12-3.12H55.79a3.13,3.13,0,0,0-3.12,3.12V94a3.14,3.14,0,0,0,3.12,3.12h1.94L54,116H68.76L65.19,97.11ZM0,116C1.47,97-2.26,97.77,13.65,91.82A122.36,122.36,0,0,0,36,80.51L49.6,116ZM87.54,78.9a91.08,91.08,0,0,0,20.61,10.29C123,94.13,123,94.82,122.86,116H73.45L87.54,78.9Z"/>
    </symbol>
    <symbol id="icon-maria" viewBox="0 0 122.88 120.94">
      <path fill="currentColor" fill-rule="evenodd" d="M31.14,67a20.57,20.57,0,0,1-9.6-6c6.43-2.42,9.39-10,9.8-21.38.31-8.45-1.44-14,1.44-22.38C38.49.71,59.57-4.94,71.32,4.72c9.21-1,18.49,3.77,20.5,18,1.49,10.6-1.68,20.21,1.67,30a15.22,15.22,0,0,0,7.85,9.3c-2.51,2.4-6.14,4-10.5,5.05-3.38.83-9.47,1.46-16.56,1.84v3.58L61.52,80.39A12.25,12.25,0,0,1,68,83.25l-3.62,7.43H56.29l-3.14-7.43a10.75,10.75,0,0,1,5.74-2.81L47,72.45V69c-6.88-.33-12.7-1-15.83-2ZM56.59,93.3l-2.25,15L40.22,90.5l2.7-16.68C35.75,76.59,9.51,86,5.89,92.76c-4.25,8-3.62,19.71-5.89,28.18H122.88c-2.27-8.47-1.65-20.22-5.89-28.18C113.37,86,87.13,76.59,80,73.82l2.7,16.68L66.84,108.42,64.54,93.3Z"/>
    </symbol>
  </svg>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1 class="header-title">面接シミュレーション</h1>
      <div class="status-badge" id="statusBadge">
        <div class="status-dot"></div>
        <span id="statusText">未接続</span>
      </div>
    </div>
  </header>

  <div class="main-container">
    <!-- Instructions -->
    <div class="instructions-card">
      <div class="instructions-header">
        <div class="instructions-icon-wrapper">
          <svg class="icon"><use href="#icon-info"></use></svg>
        </div>
        <span class="instructions-title">使い方</span>
      </div>
      <p class="instructions-text">あなたは<strong>営業担当</strong>として、外国人求職者（マリアさん）を連れて面接に来ています。</p>
      <div class="instructions-list">
        <div class="instruction-item">
          <span class="instruction-number">1</span>
          <span>「面接を開始」ボタンを押すと自動で接続し、面接官が最初の質問をします</span>
        </div>
        <div class="instruction-item">
          <span class="instruction-number">2</span>
          <span>マリアの回答後、「補足する」か「次へ進む」を選択</span>
        </div>
      </div>
    </div>

    <!-- Participants -->
    <div class="participants-bar">
      <div class="participant-chip interviewer" id="participantAiA">
        <div class="chip-avatar interviewer">
          <svg class="icon"><use href="#icon-interviewer"></use></svg>
        </div>
        <div class="chip-info">
          <span class="chip-name">面接官</span>
          <span class="chip-role">田中部長</span>
        </div>
      </div>
      <div class="participant-chip user" id="participantUser">
        <div class="chip-avatar user">
          <svg class="icon"><use href="#icon-user"></use></svg>
        </div>
        <div class="chip-info">
          <span class="chip-name">あなた</span>
          <span class="chip-role">営業担当</span>
        </div>
      </div>
      <div class="participant-chip maria" id="participantAiB">
        <div class="chip-avatar maria">
          <svg class="icon"><use href="#icon-maria"></use></svg>
        </div>
        <div class="chip-info">
          <span class="chip-name">マリア</span>
          <span class="chip-role">求職者</span>
        </div>
      </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <!-- Messages -->
      <div class="chat-messages" id="chatMessages">
        <div class="empty-state" id="emptyState">
          <div class="empty-icon-wrapper">
            <svg class="icon"><use href="#icon-message"></use></svg>
          </div>
          <p class="empty-text">「面接を開始」ボタンを押すと<br>会話が始まります</p>
        </div>
      </div>

      <!-- Audio Visualizer -->
      <div class="visualizer" id="visualizer">
        <!-- Bars added by JS -->
      </div>

      <!-- Phase Indicator -->
      <div class="phase-indicator" id="phaseIndicator">
        <div class="phase-content">
          <div class="phase-dot" id="phaseDot"></div>
          <span class="phase-text" id="phaseText">待機中</span>
        </div>
      </div>

      <!-- User Choice Buttons -->
      <div class="action-buttons" id="userChoiceButtons">
        <button class="action-btn secondary" onclick="proceedToNext()">
          次へ進む
        </button>
        <button class="action-btn success" onclick="userWillSpeak()">
          <svg class="icon icon-sm"><use href="#icon-mic"></use></svg>
          補足する
        </button>
      </div>

      <!-- User Speaking Panel -->
      <div class="user-speaking-panel" id="userSpeakingControls">
        <div class="mic-indicator">
          <div class="mic-icon-wrapper">
            <svg class="icon"><use href="#icon-mic"></use></svg>
          </div>
          <span>マイクに向かって話してください</span>
        </div>
        <button class="action-btn primary" onclick="userDoneSpeaking()">
          <svg class="icon icon-sm"><use href="#icon-check"></use></svg>
          話し終わった
        </button>
      </div>

      <!-- End Screen -->
      <div class="end-screen" id="endScreen">
        <div class="end-icon-wrapper" id="endIconWrapper">
          <svg class="icon" id="endIconSvg"><use href="#icon-check-circle"></use></svg>
        </div>
        <div class="end-title" id="endTitle">面接終了</div>
        <div class="end-message" id="endMessage"></div>
        <button class="action-btn primary" onclick="restartInterview()">
          <svg class="icon icon-sm"><use href="#icon-refresh"></use></svg>
          もう一度
        </button>
      </div>

      <!-- Control Bar -->
      <div class="control-bar" id="controlBar">
        <button class="control-btn start" id="startBtn" onclick="startInterviewFlow()">
          <svg class="icon icon-sm"><use href="#icon-play"></use></svg>
          面接を開始
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // Global State
    // ============================================================
    var websocket = null;
    var playbackAudioContext = null;
    var recordingAudioContext = null;
    var mediaStream = null;
    var audioProcessor = null;
    var isConnected = false;
    var audioSendCount = 0;

    // Audio playback queue (single queue now)
    var audioQueue = [];
    var isPlaying = false;
    var currentAudioSource = null; // 'ai_a' or 'ai_b'

    // Current phase
    var currentPhase = 'waiting';

    // ============================================================
    // UI Elements
    // ============================================================
    var statusBadge = document.getElementById('statusBadge');
    var statusText = document.getElementById('statusText');
    var startBtn = document.getElementById('startBtn');
    var chatMessages = document.getElementById('chatMessages');
    var emptyState = document.getElementById('emptyState');
    var phaseText = document.getElementById('phaseText');
    var phaseDot = document.getElementById('phaseDot');
    var userChoiceButtons = document.getElementById('userChoiceButtons');
    var userSpeakingControls = document.getElementById('userSpeakingControls');
    var endScreen = document.getElementById('endScreen');
    var endIconWrapper = document.getElementById('endIconWrapper');
    var endIconSvg = document.getElementById('endIconSvg');
    var endTitle = document.getElementById('endTitle');
    var endMessage = document.getElementById('endMessage');
    var controlBar = document.getElementById('controlBar');
    var visualizer = document.getElementById('visualizer');
    var participantAiA = document.getElementById('participantAiA');
    var participantAiB = document.getElementById('participantAiB');
    var participantUser = document.getElementById('participantUser');

    // Create visualizer bars
    for (var i = 0; i < 24; i++) {
      var bar = document.createElement('div');
      bar.className = 'visualizer-bar';
      bar.style.height = '4px';
      visualizer.appendChild(bar);
    }
    var visualizerBars = visualizer.querySelectorAll('.visualizer-bar');

    // ============================================================
    // Safe DOM Element Creation
    // ============================================================
    function createMessageElement(text, type, senderName) {
      var message = document.createElement('div');
      message.className = 'message ' + type;

      if (type === 'system') {
        var content = document.createElement('div');
        content.className = 'message-content';
        var bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = text;
        content.appendChild(bubble);
        message.appendChild(content);
      } else {
        var iconId = '';
        var displayName = senderName;

        switch (type) {
          case 'interviewer':
            iconId = 'icon-interviewer';
            displayName = displayName || '面接官';
            break;
          case 'maria':
            iconId = 'icon-maria';
            displayName = displayName || 'マリア';
            break;
          case 'user':
            iconId = 'icon-user';
            displayName = displayName || 'あなた';
            break;
        }

        var avatar = document.createElement('div');
        avatar.className = 'message-avatar ' + type;

        var avatarSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        avatarSvg.setAttribute('class', 'icon');
        var avatarUse = document.createElementNS('http://www.w3.org/2000/svg', 'use');
        avatarUse.setAttribute('href', '#' + iconId);
        avatarSvg.appendChild(avatarUse);
        avatar.appendChild(avatarSvg);

        var content = document.createElement('div');
        content.className = 'message-content';

        var sender = document.createElement('div');
        sender.className = 'message-sender';
        sender.textContent = displayName;

        var bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = text;

        content.appendChild(sender);
        content.appendChild(bubble);
        message.appendChild(avatar);
        message.appendChild(content);
      }

      return message;
    }

    // ============================================================
    // Logging / Messages
    // ============================================================
    function addMessage(text, type, senderName) {
      // Hide empty state on first message
      if (emptyState) {
        emptyState.style.display = 'none';
      }

      var messageType = type || 'system';
      var message = createMessageElement(text, messageType, senderName || '');
      chatMessages.appendChild(message);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Legacy support for addLog
    function addLog(message, type) {
      var messageType = type || 'system';
      if (type === 'ai-a') messageType = 'interviewer';
      if (type === 'ai-b') messageType = 'maria';
      addMessage(message, messageType);
    }

    // ============================================================
    // Phase Management
    // ============================================================
    function updatePhase(phase, speaker) {
      currentPhase = phase;

      // Reset all highlights
      participantAiA.classList.remove('speaking');
      participantAiB.classList.remove('speaking');
      participantUser.classList.remove('speaking');

      // Hide all phase-specific UI
      userChoiceButtons.classList.remove('visible');
      userSpeakingControls.classList.remove('visible');
      endScreen.classList.remove('visible', 'aborted');
      controlBar.style.display = 'flex';

      // Reset phase dot
      phaseDot.className = 'phase-dot';

      // Update visualizer bar colors
      visualizerBars.forEach(function(bar) {
        bar.classList.remove('interviewer', 'maria', 'active');
      });

      switch (phase) {
        case 'waiting':
          phaseText.textContent = '待機中';
          break;
        case 'interviewer':
          phaseText.textContent = '面接官が話しています...';
          phaseDot.classList.add('active', 'interviewer');
          participantAiA.classList.add('speaking');
          visualizerBars.forEach(function(bar) { bar.classList.add('interviewer'); });
          break;
        case 'maria_speaking':
          phaseText.textContent = 'マリアが答えています...';
          phaseDot.classList.add('active', 'maria');
          participantAiB.classList.add('speaking');
          visualizerBars.forEach(function(bar) { bar.classList.add('maria'); });
          break;
        case 'user_choice':
          phaseText.textContent = '補足しますか？';
          userChoiceButtons.classList.add('visible');
          controlBar.style.display = 'none';
          break;
        case 'user_speaking':
          phaseText.textContent = 'あなたのターンです';
          phaseDot.classList.add('active', 'user');
          participantUser.classList.add('speaking');
          userSpeakingControls.classList.add('visible');
          controlBar.style.display = 'none';
          startUserMicrophone();
          break;
        case 'ended':
          // Will be handled with reason in handleServerMessage
          break;
      }
    }

    function showEndScreen(reason) {
      controlBar.style.display = 'none';
      endScreen.classList.add('visible');

      var useElement = endIconSvg.querySelector('use');

      if (reason === 'aborted') {
        phaseText.textContent = '面接中止';
        useElement.setAttribute('href', '#icon-alert-triangle');
        endTitle.textContent = '面接中止';
        endMessage.textContent = '面接官が面接を打ち切りました。不適切な発言があったようです。';
        endScreen.classList.add('aborted');
        addMessage('面接が打ち切られました', 'system');
      } else {
        phaseText.textContent = '面接終了';
        useElement.setAttribute('href', '#icon-check-circle');
        endTitle.textContent = '面接終了';
        endMessage.textContent = 'お疲れ様でした。面接が終了しました。';
        addMessage('面接が正常に終了しました', 'system');
      }
    }

    // ============================================================
    // WebSocket Connection
    // ============================================================
    function connect(callback) {
      var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      var wsUrl = protocol + '//' + window.location.host + '/ws';

      statusBadge.classList.remove('connected');
      statusBadge.classList.add('connecting');
      statusText.textContent = '接続中...';

      websocket = new WebSocket(wsUrl);

      websocket.onopen = function() {
        isConnected = true;
        statusBadge.classList.remove('connecting');
        statusBadge.classList.add('connected');
        statusText.textContent = '接続中';
        if (callback) callback();
      };

      websocket.onmessage = function(event) {
        try {
          var data = JSON.parse(event.data);
          handleServerMessage(data);
        } catch (error) {
          console.error('Failed to parse message:', error);
        }
      };

      websocket.onclose = function() {
        handleDisconnect();
      };

      websocket.onerror = function(error) {
        console.error('WebSocket error:', error);
        addMessage('接続エラーが発生しました', 'system');
        handleDisconnect();
      };
    }

    function disconnect() {
      if (websocket) {
        websocket.close();
      }
      handleDisconnect();
    }

    function handleDisconnect() {
      isConnected = false;
      statusBadge.classList.remove('connected', 'connecting');
      statusText.textContent = '未接続';
      startBtn.disabled = false;
      updatePhase('waiting');
      stopUserMicrophone();
    }

    // ============================================================
    // Server Message Handling
    // ============================================================
    function handleServerMessage(data) {
      switch (data.type) {
        case 'phase_change':
          console.log('[Phase Change]', data.phase, data.speaker, data.reason);
          if (data.phase === 'ended') {
            updatePhase(data.phase);
            showEndScreen(data.reason);
          } else {
            updatePhase(data.phase, data.speaker);
          }
          break;

        case 'transcript':
          // AI transcript received
          var msgType = data.source === 'ai_a' ? 'interviewer' : 'maria';
          addMessage(data.text, msgType, data.name);
          break;

        case 'audio':
          // Audio to play (queued)
          audioQueue.push({ source: data.source, data: data.data });
          if (!isPlaying) {
            playNextAudio();
          }
          break;

        case 'error':
          addMessage('エラー: ' + data.message, 'system');
          break;

        default:
          console.log('Unknown message type:', data.type);
      }
    }

    // ============================================================
    // Audio Playback (Sequential, Single Queue)
    // ============================================================
    async function initPlaybackContext() {
      if (!playbackAudioContext) {
        playbackAudioContext = new (window.AudioContext || window.webkitAudioContext)({
          sampleRate: 24000,
        });
        console.log('[Audio] Playback context sample rate:', playbackAudioContext.sampleRate);
      }
      if (playbackAudioContext.state === 'suspended') {
        await playbackAudioContext.resume();
      }
    }

    async function initRecordingContext() {
      if (!recordingAudioContext) {
        recordingAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        console.log('[Audio] Recording context sample rate:', recordingAudioContext.sampleRate);
      }
      if (recordingAudioContext.state === 'suspended') {
        await recordingAudioContext.resume();
      }
    }

    function base64ToArrayBuffer(base64) {
      var binaryString = atob(base64);
      var bytes = new Uint8Array(binaryString.length);
      for (var i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes.buffer;
    }

    function pcm16ToFloat32(pcm16Buffer) {
      var int16Array = new Int16Array(pcm16Buffer);
      var float32Array = new Float32Array(int16Array.length);
      for (var i = 0; i < int16Array.length; i++) {
        float32Array[i] = int16Array[i] / 32768;
      }
      return float32Array;
    }

    async function playNextAudio() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        currentAudioSource = null;

        // When audio queue is empty, notify server that playback is done
        console.log('[Audio] Queue empty, notifying server');
        if (websocket && websocket.readyState === WebSocket.OPEN) {
          websocket.send(JSON.stringify({ type: 'audio_playback_done' }));
        }
        return;
      }

      isPlaying = true;

      await initPlaybackContext();

      var audioItem = audioQueue.shift();
      currentAudioSource = audioItem.source;

      var pcmBuffer = base64ToArrayBuffer(audioItem.data);
      var floatData = pcm16ToFloat32(pcmBuffer);

      var audioBuffer = playbackAudioContext.createBuffer(1, floatData.length, 24000);
      audioBuffer.getChannelData(0).set(floatData);

      var source = playbackAudioContext.createBufferSource();
      source.buffer = audioBuffer;
      source.connect(playbackAudioContext.destination);
      source.onended = function() { playNextAudio(); };
      source.start();

      updateVisualizer(floatData);
    }

    function updateVisualizer(audioData) {
      var step = Math.floor(audioData.length / visualizerBars.length);
      for (var i = 0; i < visualizerBars.length; i++) {
        var value = Math.abs(audioData[i * step] || 0);
        var height = Math.max(4, value * 80);
        visualizerBars[i].style.height = height + 'px';
      }

      setTimeout(function() {
        for (var j = 0; j < visualizerBars.length; j++) {
          visualizerBars[j].style.height = '4px';
        }
      }, 100);
    }

    // ============================================================
    // User Microphone
    // ============================================================
    async function startUserMicrophone() {
      try {
        await initRecordingContext();

        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            channelCount: 1,
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
          },
        });

        console.log('[Audio] User microphone started');

        var source = recordingAudioContext.createMediaStreamSource(mediaStream);
        audioProcessor = recordingAudioContext.createScriptProcessor(4096, 1, 1);

        audioProcessor.onaudioprocess = function(event) {
          if (currentPhase !== 'user_speaking' || !websocket || websocket.readyState !== WebSocket.OPEN) {
            return;
          }

          var inputData = event.inputBuffer.getChannelData(0);
          var maxVal = 0;
          for (var i = 0; i < inputData.length; i++) {
            var absVal = Math.abs(inputData[i]);
            if (absVal > maxVal) maxVal = absVal;
          }

          if (maxVal < 0.0001) {
            return;
          }

          var resampledData = resampleTo24k(inputData, recordingAudioContext.sampleRate);
          var pcm16 = float32ToPcm16(resampledData);
          var base64 = arrayBufferToBase64(pcm16.buffer);

          websocket.send(JSON.stringify({
            type: 'audio',
            data: base64,
          }));

          audioSendCount++;
          if (audioSendCount % 100 === 0) {
            console.log('[Audio] Sent ' + audioSendCount + ' audio chunks');
          }
        };

        source.connect(audioProcessor);
        audioProcessor.connect(recordingAudioContext.destination);

        audioSendCount = 0;
      } catch (error) {
        console.error('Failed to start microphone:', error);
        addMessage('マイクエラー: ' + error.message, 'system');
      }
    }

    function stopUserMicrophone() {
      if (audioProcessor) {
        audioProcessor.disconnect();
        audioProcessor = null;
      }

      if (mediaStream) {
        mediaStream.getTracks().forEach(function(track) { track.stop(); });
        mediaStream = null;
      }
    }

    function resampleTo24k(inputData, inputSampleRate) {
      if (inputSampleRate === 24000) {
        return inputData;
      }

      var ratio = inputSampleRate / 24000;
      var outputLength = Math.floor(inputData.length / ratio);
      var outputData = new Float32Array(outputLength);

      for (var i = 0; i < outputLength; i++) {
        var inputIndex = Math.floor(i * ratio);
        outputData[i] = inputData[inputIndex];
      }

      return outputData;
    }

    function float32ToPcm16(float32Array) {
      var pcm16 = new Int16Array(float32Array.length);
      for (var i = 0; i < float32Array.length; i++) {
        var s = Math.max(-1, Math.min(1, float32Array[i]));
        pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
      }
      return pcm16;
    }

    function arrayBufferToBase64(buffer) {
      var bytes = new Uint8Array(buffer);
      var binary = '';
      for (var i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }

    // ============================================================
    // User Actions
    // ============================================================
    function startInterviewFlow() {
      startBtn.disabled = true;

      if (!isConnected) {
        // Connect first, then start interview
        connect(function() {
          startInterview();
        });
      } else {
        startInterview();
      }
    }

    function startInterview() {
      if (!websocket || websocket.readyState !== WebSocket.OPEN) {
        addMessage('サーバーに接続されていません', 'system');
        startBtn.disabled = false;
        return;
      }

      websocket.send(JSON.stringify({
        type: 'start_interview',
      }));

      addMessage('面接を開始します...', 'system');
    }

    function proceedToNext() {
      if (!websocket || websocket.readyState !== WebSocket.OPEN) return;

      websocket.send(JSON.stringify({
        type: 'proceed_to_next',
      }));

      addMessage('次の質問へ', 'system');
    }

    function userWillSpeak() {
      if (!websocket || websocket.readyState !== WebSocket.OPEN) return;

      websocket.send(JSON.stringify({
        type: 'user_will_speak',
      }));

      addMessage('補足します', 'user');
    }

    function userDoneSpeaking() {
      if (!websocket || websocket.readyState !== WebSocket.OPEN) return;

      stopUserMicrophone();

      websocket.send(JSON.stringify({
        type: 'user_done_speaking',
      }));

      addMessage('発言終了', 'user');
    }

    function restartInterview() {
      // Disconnect and reconnect to reset state
      if (websocket) {
        websocket.close();
      }
      // Clear messages safely
      while (chatMessages.firstChild) {
        chatMessages.removeChild(chatMessages.firstChild);
      }
      // Re-add empty state
      var newEmptyState = document.createElement('div');
      newEmptyState.className = 'empty-state';
      newEmptyState.id = 'emptyState';

      var emptyIconWrapper = document.createElement('div');
      emptyIconWrapper.className = 'empty-icon-wrapper';
      var emptyIconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      emptyIconSvg.setAttribute('class', 'icon');
      var emptyIconUse = document.createElementNS('http://www.w3.org/2000/svg', 'use');
      emptyIconUse.setAttribute('href', '#icon-message');
      emptyIconSvg.appendChild(emptyIconUse);
      emptyIconWrapper.appendChild(emptyIconSvg);

      var emptyText = document.createElement('p');
      emptyText.className = 'empty-text';
      emptyText.textContent = '「面接を開始」ボタンを押すと会話が始まります';

      newEmptyState.appendChild(emptyIconWrapper);
      newEmptyState.appendChild(emptyText);
      chatMessages.appendChild(newEmptyState);

      // Reset button
      startBtn.disabled = false;
    }
  </script>
</body>
</html>
